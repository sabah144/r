<!-- Cleaned from original admin-reservations.html. Source: :contentReference[oaicite:0]{index=0} -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم – معلومات الحجوزات</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Supabase keys (project-specific) -->
  <script>
    window.SUPABASE_URL  = "https://ivotznbljtzjdmlsyqcq.supabase.co";
    window.SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2b3R6bmJsanR6amRtbHN5cWNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDcyMzksImV4cCI6MjA3MjMyMzIzOX0.umCkEdzG0B7hEMJEg6eRMQEBzWHypLaREfxxjkuo_uw";
  </script>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
  </script>

  <!-- Live broadcast (notify & refresh) -->
  <script type="module">
    const ch = window.supabase
      .channel('live', { config: { broadcast: { self: true } } })
      .on('broadcast', { event: 'new-order' }, async () => {
        // retry until bridge is ready, then sync + soft refresh
        const trySync = async (tries = 10) => {
          if (window.supabaseBridge?.syncAdminDataToLocal) {
            try { await window.supabaseBridge.syncAdminDataToLocal(); } catch (e) { console.error(e); }
          } else if (tries > 0) {
            setTimeout(() => trySync(tries - 1), 300);
          }
        };
        await trySync();
        try { updateAll(); } catch {}
      });
    ch.subscribe().catch(()=>{});
    window.__ADM_LIVE = ch;
  </script>

  <!-- Supabase bridge (helpers & syncing) -->
  <script type="module" src="supabase-bridge.js"></script>

  <!-- Optional: pre-sync public catalog (non-blocking) -->
  <script type="module">
    import { syncPublicCatalogToLocal } from './supabase-bridge.js';
    syncPublicCatalogToLocal().catch(()=>{});
  </script>

  <!-- Page styles (scoped) -->
  <style>
    /* Only show the reservations section on this page */
    main > section { display: none; }
    main > section#reservations { display: block; }

    /* Reservations header actions */
    .res-tabs { display:flex; flex-wrap:wrap; gap:8px; margin:0 0 10px; }
    .res-tab { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .res-tab[aria-selected="true"] { background:#0f766e; color:#fff; border-color:#0f766e; }
    .res-tab .count { font-weight:900; min-width:24px; text-align:center; }
    .res-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .res-search { flex:1 1 240px; }
    .res-search .input { width:100%; height:36px; }

    .table-card { border:1px solid #eef2f7; border-radius:12px; background:#fff; overflow:hidden; }
    .table-wrap { overflow:auto; }
    .table-soft { width:100%; border-collapse:collapse; }
    .table-soft thead th { background:#f8fafc; font-weight:900; text-align:right; padding:10px 12px; border-bottom:1px solid #eef2f7; white-space:nowrap; }
    .table-soft td { padding:10px 12px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
    .table-soft tr.conflict { background:#fff1f2; }
    .table-soft .col-ops { width:1%; white-space:nowrap; }

    .table-footer {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-top:1px solid #eef2f7; background:#fff;
    }
    .pager { display:flex; align-items:center; gap:10px; }
    .pager .btn { border-radius:999px; }
    .page-size { display:flex; align-items:center; gap:6px; color:#6b7280; }
    .page-size select { height:32px; border-radius:999px; border:1px solid #e5e7eb; padding:0 10px; background:#fff; }

    /* Embedded mode */
    body.is-embed .navbar,
    body.is-embed .sidebar,
    body.is-embed #notifDrawer { display:none !important; }
    body.is-embed .admin-layout { grid-template-columns: 1fr; }
    body.is-embed .main { padding:12px; }
    body.is-embed .section.card { box-shadow:none; border:0; padding:0; }

    /* Misc spacing/tweaks */
    .table-soft .col-name { min-width:160px; }
    .table-soft .col-phone { min-width:140px; }
    .ops-inline { display:flex; align-items:center; gap:8px; flex-wrap:nowrap; overflow-x:auto; padding-bottom:2px; }

    /* Busy lock */
    button[aria-busy="true"], .is-busy { pointer-events:none !important; opacity:.6 !important; }
  </style>
</head>
<body>
  <!-- Top bar -->
  <nav class="navbar">
    <div class="container row">
      <div class="brand">لوحة تحكم المطعم</div>
      <div class="nav-actions">
        <button id="logoutBtn" class="btn btn-ghost">تسجيل الخروج</button>
        <a href="index.html" class="btn btn-ghost">عرض الموقع</a>
        <button id="refresh" class="btn btn-primary">تحديث</button>
        <div class="icon-btn" id="notifyBtn" title="الإشعارات">
          <span id="notifCount" class="icon-badge" style="display:none">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 17h5l-1.4-1.4A2 2 0 0118 14.17V11a6 6 0 00-12 0v3.17a2 2 0 01-.6 1.43L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
        </div>
      </div>
    </div>
  </nav>

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h3>المعلومات</h3>
      <a class="side-link" href="admin.html">لوحة المعلومات</a>
      <a class="side-link" href="admin-orders.html">إدارة الطلبات</a>
      <a class="side-link" href="admin-menu.html">إدارة المنيو</a>
      <a class="side-link" href="admin-cats.html">إدارة الأقسام</a>
      <a class="side-link" href="admin-ratings.html">إدارة التقييمات</a>
      <a class="side-link" href="admin-reports.html">التقارير</a>
      <a class="side-link active" href="admin-reservations.html" aria-current="page">معلومات الحجوزات</a>

      <div class="section">
        <div class="notice small">من هنا يمكنك متابعة وتأكيد الحجوزات القادمة وإسناد الطاولات وملاحظات الزبائن.</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div id="warnBar"></div>

      <!-- KPIs -->
      <section class="kpis">
        <div class="kpi">
          <div class="small" style="margin-bottom:6px">إجمالي الحجوزات</div>
          <div id="k_all" style="font-weight:900; font-size:28px">0</div>
        </div>
        <div class="kpi">
          <div class="small" style="margin-bottom:6px">اليوم</div>
          <div id="k_today" style="font-weight:900; font-size:28px">0</div>
        </div>
        <div class="kpi">
          <div class="small" style="margin-bottom:6px">هذا الأسبوع</div>
          <div id="k_week" style="font-weight:900; font-size:28px">0</div>
        </div>
        <div class="kpi">
          <div class="small" style="margin-bottom:6px">هذا الشهر</div>
          <div id="k_month" style="font-weight:900; font-size:28px">0</div>
        </div>
      </section>

      <!-- Reservations -->
      <section id="reservations" class="section card">
        <div class="head">
          <div class="title">
            <h3>الحجوزات</h3>
            <div class="small muted">إدارة حجوزات الزبائن، الحالات، والطاولات.</div>
          </div>
        </div>

        <div class="body" style="display:grid; gap:10px">
          <!-- Row 1: tabs -->
          <div class="res-tabs" id="resTabs" role="tablist" aria-label="حالات الحجوزات">
            <button class="res-tab" data-tab="all" aria-selected="true"><span class="count" id="ct_all">0</span><span>الكل</span></button>
            <button class="res-tab" data-tab="new" aria-selected="false"><span class="count" id="ct_new">0</span><span>جديد</span></button>
            <button class="res-tab" data-tab="confirmed" aria-selected="false"><span class="count" id="ct_confirmed">0</span><span>مؤكد</span></button>
            <button class="res-tab" data-tab="assigned" aria-selected="false"><span class="count" id="ct_assigned">0</span><span>مسند</span></button>
            <button class="res-tab" data-tab="seated" aria-selected="false"><span class="count" id="ct_seated">0</span><span>جالس</span></button>
            <button class="res-tab" data-tab="done" aria-selected="false"><span class="count" id="ct_done">0</span><span>منجز</span></button>
            <button class="res-tab" data-tab="canceled" aria-selected="false"><span class="count" id="ct_canceled">0</span><span>ملغي</span></button>
          </div>

          <!-- Row 2: actions -->
          <div class="res-actions">
            <div class="res-search">
              <input id="q" class="input" placeholder="ابحث بالاسم / الهاتف / #المعرف / رقم الطاولة" />
            </div>
            <button id="conflictsBtn" class="btn btn-ghost" title="عرض التعارضات">عرض التعارضات</button>
            <button id="addBtn" class="btn btn-olive">إضافة حجز</button>
            <button id="exportBtn" class="btn btn-ghost">تصدير CSV</button>
          </div>

          <div class="small muted" style="margin:4px 0 12px">
            يمكن إدخال أكثر من طاولة: <span class="mono">8,9</span> أو <span class="mono">3-5</span>. الصف الوردي يعني وجود تعارض.
          </div>

          <!-- Table -->
          <div class="table-card">
            <div class="table-wrap">
              <table class="table-soft" id="resTable" aria-label="جدول الحجوزات">
                <thead>
                  <tr>
                    <th class="nowrap">#</th>
                    <th class="col-name">الاسم</th>
                    <th class="col-phone">الهاتف</th>
                    <th>التاريخ</th>
                    <th>الوقت</th>
                    <th>الأشخاص</th>
                    <th>طاولة</th>
                    <th>الحالة</th>
                    <th>ملاحظات</th>
                    <th class="col-ops">عمليات</th>
                  </tr>
                </thead>
                <tbody id="resBody"></tbody>
              </table>
            </div>

            <!-- Footer: paging -->
            <div class="table-footer">
              <div class="page-size">
                <label for="pageSize" class="small">صفحة:</label>
                <select id="pageSize">
                  <option value="10">10</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                </select>
              </div>
              <div class="pager">
                <button id="prevPage" class="btn" aria-label="السابق">‹</button>
                <div id="pageInfo" class="small">1 / 1</div>
                <button id="nextPage" class="btn" aria-label="التالي">›</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Notifications drawer -->
  <aside class="drawer" id="notifDrawer" aria-hidden="true" style="width:420px">
    <div class="head">
      <strong>الإشعارات</strong>
      <button class="btn btn-ghost" id="closeNotif">إغلاق</button>
    </div>
    <div class="body">
      <div id="notifSummary" class="small" style="margin-bottom:8px; color:var(--muted)"></div>
      <div id="notifList"></div>
    </div>
    <div class="totals">
      <button id="markAllRead" class="btn btn-primary">تمييز الكل كمقروء</button>
    </div>
  </aside>

  <!-- Global App Modal -->
  <div id="appModal" class="modal app-modal-overlay" aria-hidden="true">
    <div class="app-modal" role="dialog" aria-modal="true" aria-labelledby="appModalTitle" style="padding:0; background:#fff; color:#111; max-width:min(560px,95vw)">
      <header style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid #eee">
        <h3 id="appModalTitle">—</h3>
        <button id="appModalClose" class="btn btn-ghost">إغلاق</button>
      </header>
      <div class="body" id="appModalBody" style="padding:14px; max-height:60vh; overflow:auto"></div>
      <footer class="actions" id="appModalActions" style="display:flex; gap:8px; justify-content:flex-start; padding:12px 14px; border-top:1px solid #eee"></footer>
    </div>
  </div>

  <!-- Base admin scripts -->
  <script src="admin.js"></script>
  <script src="admin-multipage.js"></script>

  <!-- Boot (auth + sync) -->
  <script>
    (async function boot() {
      if (document.readyState === 'loading') {
        await new Promise(r => document.addEventListener('DOMContentLoaded', r, { once:true }));
      }
      for (let i = 0; i < 50 && !window.supabaseBridge; i++) {
        await new Promise(r => setTimeout(r, 100));
      }
      const B = window.supabaseBridge;
      try { await B?.requireAdminOrRedirect?.('login.html'); } catch (e) { console.error(e); }
      try { await B?.syncAdminDataToLocal?.(); } catch (e) { console.error(e); }
      try { updateAll?.(); } catch {}
      try { window.dispatchEvent(new Event('storage')); } catch {}
    })();
  </script>

  <!-- Page logic -->
  <script>
    (function () {
      /* ===== Helpers ===== */
      const LS = window.LS || {
        get: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } },
        set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
      };
      const setText = window.setText || ((sel, v) => { const el = document.querySelector(sel); if (el) el.textContent = String(v ?? ''); });

      // fallback modal API if admin-multipage.js not ready
      if (!window.showModal) {
        window.showModal = ({ title = '', bodyHTML = '', actions = [] } = {}) => {
          alert((title ? title + '\n' : '') + String(bodyHTML || '').replace(/<[^>]+>/g, ''));
          (actions.find(a => /موافق|إغلاق|إلغاء/.test(a?.label))?.onClick || (() => {}))();
        };
        window.hideModal = () => {};
        window.Modal = { info: (body, title = 'تنبيه') => alert((title ? title + '\n' : '') + String(body ?? '')) };
      }

      // digits normalization (Arabic → Latin)
      const AR_MAP = { '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9' };
      function toLatn(s){ return String(s).replace(/[٠-٩۰-۹]/g, ch => AR_MAP[ch] ?? ch); }

      // formatting
      const LOCALE = 'ar-EG-u-nu-latn';
      const nfmt = new Intl.NumberFormat(LOCALE);
      const dfmt = new Intl.DateTimeFormat('en-GB', { year:'numeric', month:'2-digit', day:'2-digit' }); // DD/MM/YYYY
      const tfmt = new Intl.DateTimeFormat('en-GB', { hour:'2-digit', minute:'2-digit', hour12:false });  // HH:MM
      const fmtNum = n => nfmt.format(Number(n)||0);

      // datetime helpers
      const toLocalInputValue = (d) => {
        try{
          const pad = (x) => String(x).padStart(2,'0');
          return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }catch{ return ''; }
      };
      const splitDateTime = (iso) => {
        const dt = iso ? new Date(iso) : null;
        return { d: dt ? dfmt.format(dt) : '-', t: dt ? tfmt.format(dt) : '-' };
      };

      // tables parsing "8,9" or "3-5"
      function parseTables(s) {
        const out = new Set();
        String(s || '').split(',').map(x => x.trim()).filter(Boolean).forEach(part => {
          if (/^\d+-\d+$/.test(part)) {
            const [a, b] = part.split('-').map(x => +toLatn(x));
            const lo = Math.min(a, b), hi = Math.max(a, b);
            for (let n = lo; n <= hi; n++) out.add(String(n));
          } else if (/^\d+$/.test(part)) {
            out.add(String(+toLatn(part)));
          }
        });
        return Array.from(out).sort((a,b)=>+a-+b);
      }
      function intersectTables(a, b) {
        const A = new Set(parseTables(a));
        const B = new Set(parseTables(b));
        const out = [];
        A.forEach(x => { if (B.has(x)) out.push(x); });
        return out.sort((x,y)=>+x-+y);
      }
      const formatTables = (s) => parseTables(s).join(',');

      // status mapping
      const STATUSES = ['new','confirmed','assigned','seated','done','canceled'];
      const statusLabel = (s) => ({
        new:'جديد', confirmed:'مؤكد', assigned:'مسند', seated:'جالس', done:'منتهٍ', canceled:'ملغي'
      })[s] || s;

      const getDefaultDuration = () => 90;

      // state
      const R = {
        tab: 'all',
        q: '',
        page: 1,
        size: Number(localStorage.getItem('res_page_size') || 10),
        showConflicts: false
      };

      // data access
      function listAll(){
        return (LS.get('reservations', []) || []).slice().sort((a,b) => (a.date||'').localeCompare(b.date||''));
      }

      function norm(s){ return toLatn(String(s||'').trim()); }

      function matchQuery(r){
        const q = norm(R.q);
        if (!q) return true;
        const hay = [
          String(r.id||''),
          String(r.name||''),
          toLatn(r.phone||''),
          formatTables(r.table||'')
        ].join(' ').toLowerCase();
        return hay.includes(q.toLowerCase());
      }

      // conflicts
      function overlaps(aStart, aDur, bStart, bDur){
        const a0 = new Date(aStart).getTime();
        const a1 = a0 + (Number(aDur)||getDefaultDuration())*60000;
        const b0 = new Date(bStart).getTime();
        const b1 = b0 + (Number(bDur)||getDefaultDuration())*60000;
        return Math.max(a0,b0) < Math.min(a1,b1);
      }
      function conflictsFor(row, list, ignoreId=null){
        const me = { ...row, table: formatTables(row.table||'') };
        return (list||[]).filter(r=>{
          if (String(r.id) === String(ignoreId)) return false;
          if (!me.table || !r.table) return false;
          if (!overlaps(me.date, me.duration, r.date, r.duration)) return false;
          return intersectTables(me.table, r.table).length > 0;
        });
      }

      // counters & KPIs
      function updateCounters(list){
        const by = (s) => list.filter(r => (s==='all' ? true : (r.status||'new') === s)).length;
        setText('#ct_all',       fmtNum(by('all')));
        setText('#ct_new',       fmtNum(by('new')));
        setText('#ct_confirmed', fmtNum(by('confirmed')));
        setText('#ct_assigned',  fmtNum(by('assigned')));
        setText('#ct_seated',    fmtNum(by('seated')));
        setText('#ct_done',      fmtNum(by('done')));
        setText('#ct_canceled',  fmtNum(by('canceled')));

        // KPIs
        const now = new Date();
        const startOfDay = new Date(now); startOfDay.setHours(0,0,0,0);
        const endOfDay   = new Date(now); endOfDay.setHours(23,59,59,999);

        const startOfWeek = new Date(startOfDay); startOfWeek.setDate(startOfWeek.getDate() - ((startOfWeek.getDay()+6)%7));
        const endOfWeek   = new Date(startOfWeek); endOfWeek.setDate(endOfWeek.getDate()+6); endOfWeek.setHours(23,59,59,999);

        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const endOfMonth   = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);

        const inRange = (d, a, b) => d && d >= a && d <= b;

        setText('#k_all',   fmtNum(list.length));
        setText('#k_today', fmtNum(list.filter(r => inRange(new Date(r.date||0), startOfDay, endOfDay)).length));
        setText('#k_week',  fmtNum(list.filter(r => inRange(new Date(r.date||0), startOfWeek, endOfWeek)).length));
        setText('#k_month', fmtNum(list.filter(r => inRange(new Date(r.date||0), startOfMonth, endOfMonth)).length));
      }

      // render
      function render(){
        const all = listAll();
        updateCounters(all);

        let filtered = all.filter(r => R.tab==='all' ? true : (r.status||'new') === R.tab)
                          .filter(matchQuery);

        const total = filtered.length;
        const pages = Math.max(1, Math.ceil(total / R.size));
        if (R.page > pages) R.page = pages;
        if (R.page < 1) R.page = 1;

        const start = (R.page - 1) * R.size;
        const pageRows = filtered.slice(start, start + R.size);

        const tbody = document.getElementById('resBody');
        if (!tbody) return;

        if (pageRows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="small muted">لا يوجد حجوزات مطابقة.</td></tr>';
        } else {
          tbody.innerHTML = pageRows.map((r, i) => {
            const idx = start + i + 1;
            const dt = splitDateTime(r.date);
            const conflict = R.showConflicts && conflictsFor(r, all, r.id).length > 0;
            const safeId = JSON.stringify(r.id);
            return `
              <tr class="${conflict ? 'conflict' : ''}">
                <td class="mono">${fmtNum(idx)}</td>
                <td>${(r.name||'-')}</td>
                <td class="mono">${toLatn(r.phone||'')}</td>
                <td>${dt.d}</td>
                <td>${dt.t}</td>
                <td class="mono">${fmtNum(r.people||1)}</td>
                <td class="mono">${formatTables(r.table||'')}</td>
                <td>${statusLabel(r.status||'new')}</td>
                <td>${(r.notes||'—')}</td>
                <td class="col-ops">
                  <div class="ops-inline">
                    <button class="btn-badge btn-badge--ghost" onclick='__res.print(${safeId}, this)'>طباعة</button>
                    <button class="btn-badge btn-badge--ghost" onclick='__res.assignTable(${safeId}, this)'>تعيين طاولة</button>
                    <button class="btn-badge btn-badge--ghost" onclick='__res.edit(${safeId}, this)'>تعديل</button>
                    <button class="btn-badge btn-badge--danger" onclick='__res.remove(${safeId}, this)'>حذف</button>
                  </div>
                </td>
              </tr>`;
          }).join('');
        }

        // pager
        setText('#pageInfo', fmtNum(R.page) + ' / ' + fmtNum(Math.max(1, Math.ceil(total / R.size))));
        const prevBtn = document.getElementById('prevPage');
        const nextBtn = document.getElementById('nextPage');
        if (prevBtn) prevBtn.disabled = (R.page <= 1);
        if (nextBtn) nextBtn.disabled = (R.page >= Math.ceil(total / R.size) || Math.ceil(total / R.size) === 0);
      }

      async function changeStatus(id, to){
        try{
          await window.supabaseBridge.updateReservationSB(id, { status: to });
          const ns = LS.get('notifications', []);
          ns.unshift({
            id: crypto.randomUUID(),
            type: 'reservation',
            title: `تحديث حالة الحجز #${id}`,
            message: `الحالة الجديدة: ${to}`,
            time: new Date().toISOString(),
            read: false
          });
          LS.set('notifications', ns);
          await window.supabaseBridge.syncAdminDataToLocal();
          render();
        }catch(e){
          Modal?.info?.('تعذّر تحديث الحالة','خطأ');
        }
      }

      function openForm(title, r, onSubmit){
        const html = `
          <div class="app-grid">
            <div>
              <label class="app-label">الاسم</label>
              <input class="app-input" id="f_name" value="${r?.name||''}">
            </div>
            <div>
              <label class="app-label">الهاتف</label>
              <input class="app-input" id="f_phone" value="${toLatn(r?.phone||'')}">
            </div>
            <div>
              <label class="app-label">التاريخ والوقت</label>
              <input class="app-input" id="f_date" type="datetime-local" value="${r?.date ? toLocalInputValue(new Date(r.date)) : ''}">
            </div>
            <div>
              <label class="app-label">عدد الأشخاص</label>
              <input class="app-input" id="f_people" type="number" min="1" value="${r?.people ?? 2}">
            </div>
            <div>
              <label class="app-label">رقم الطاولة/الطاولات</label>
              <input class="app-input" id="f_table" placeholder="مثال: 8,9 أو 3-5" value="${r?.table ? formatTables(r.table) : ''}">
            </div>
            <div>
              <label class="app-label">المدة (دقائق)</label>
              <input class="app-input" id="f_duration" type="number" min="15" step="5" value="${r?.duration ?? getDefaultDuration()}">
            </div>
            <div>
              <label class="app-label">الحالة</label>
              <select class="app-input" id="f_status">
                ${STATUSES.map(s => `<option value="${s}" ${s===(r?.status||'new')?'selected':''}>${statusLabel(s)}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="app-grid-1" style="margin-top:10px">
            <div>
              <label class="app-label">ملاحظات</label>
              <textarea class="app-input" id="f_notes" rows="3">${r?.notes ?? ''}</textarea>
            </div>
          </div>
        `;
        showModal({
          title,
          bodyHTML: html,
          actions: [
            { label:'إلغاء', className:'btn btn-ghost', onClick: hideModal },
            { label:'حفظ', className:'btn btn-primary', onClick: async ()=>{
                const name   = document.getElementById('f_name').value.trim();
                const phone  = toLatn(document.getElementById('f_phone').value.trim());
                const date   = document.getElementById('f_date').value;
                const people = Number(toLatn(document.getElementById('f_people').value || '2'));
                const table  = (document.getElementById('f_table').value || '').trim();
                const duration = Number(toLatn(document.getElementById('f_duration').value || getDefaultDuration()));
                const status = document.getElementById('f_status').value;
                const notes  = document.getElementById('f_notes').value.trim();
                if(!name || !phone || !date || !people){
                  showModal({ title:'تنبيه', bodyHTML:'يرجى تعبئة الحقول الأساسية.', actions:[{label:'موافق', className:'btn btn-primary', onClick: hideModal}] });
                  return;
                }
                const iso = new Date(date).toISOString();
                const list = listAll();
                const candidate = { id: r?.id || 'new', name, phone, date: iso, people, table, duration, status, notes };
                const conflicts = conflictsFor(candidate, list, r?.id || null);
                if(conflicts.length){
                  const msg = 'يوجد ' + conflicts.length + ' تعارض(ات) على الطاولات: ' + formatTables(table) + '.\n' + conflicts.map(c=>{
                    const over = intersectTables(candidate.table, c.table);
                    const s = splitDateTime(c.date);
                    return '• #' + String(c.id).slice(0,6) + ' — طاولة ' + over.join(', ') + ' — ' + s.d + ' ' + s.t;
                  }).join('\n');
                  const proceed = await new Promise(resolve=>{
                    showModal({
                      title:'تعارضات مكتشفة',
                      bodyHTML:`<pre style="white-space:pre-wrap;font-family:inherit">${msg}</pre><div class="small muted">هل تريد المتابعة والحفظ رغم التعارض؟</div>`,
                      actions:[
                        {label:'تراجع', className:'btn btn-ghost', onClick: ()=>{ hideModal(); resolve(false); }},
                        {label:'متابعة', className:'btn btn-primary', onClick: ()=>{ hideModal(); resolve(true); }},
                      ],
                    });
                  });
                  if(!proceed) return;
                }
                onSubmit({ name, phone, date: iso, people, table, status, notes, iso, duration });
                hideModal(); render();
              } }
          ]
        });
      }

      // public API for row ops
      window.__res = {
        async remove(id, el){
          const ok = await new Promise(resolve => {
            showModal({
              title:'تأكيد الحذف',
              bodyHTML:'سيتم حذف الحجز نهائيًا.',
              actions:[
                { label:'إلغاء', className:'btn btn-ghost', onClick: ()=>{ hideModal(); resolve(false); } },
                { label:'حذف', className:'btn btn-danger', onClick: ()=>{ hideModal(); resolve(true); } }
              ]
            });
          });
          if (!ok) return;

          try{
            if (window.supabaseBridge?.deleteReservationSB) {
              el?.setAttribute('aria-busy','true');
              await window.supabaseBridge.deleteReservationSB(id);
              await window.supabaseBridge.syncAdminDataToLocal();
            } else {
              const list = listAll().filter(r => String(r.id) !== String(id));
              LS.set('reservations', list);
            }
            render();
          }catch(e){
            console.error(e);
            Modal?.info?.('تعذّر حذف الحجز.','خطأ');
          }finally{
            el?.removeAttribute?.('aria-busy');
          }
        },

        edit(id, el){
          const list = listAll();
          const r = list.find(x => String(x.id) === String(id));
          if (!r) return;
          openForm('تعديل الحجز', r, async (data)=>{
            try{
              el?.setAttribute('aria-busy','true');
              await window.supabaseBridge.updateReservationSB(id, {
                name: data.name, phone: data.phone, date: data.date, people: data.people,
                status: data.status, notes: data.notes, table_no: data.table, duration_minutes: data.duration
              });
              await window.supabaseBridge.syncAdminDataToLocal();
              render();
            }catch(e){
              Modal?.info?.('تعذّر التعديل','خطأ');
            }finally{
              el?.removeAttribute?.('aria-busy');
            }
          });
        },

        async assignTable(id, el){
          const r = listAll().find(x => String(x.id) === String(id));
          if (!r) return;
          const html = `
            <div class="form">
              <label class="app-label">رقم الطاولة/الطاولات</label>
              <input id="at_table" class="input" placeholder="مثال: 8,9 أو 3-5" value="${formatTables(r.table||'')}">
              <label class="app-label" style="margin-top:8px">المدة (دقائق)</label>
              <input id="at_duration" class="input" type="number" min="15" step="5" value="${r.duration||getDefaultDuration()}">
            </div>`;
          const save = async ()=>{
            const table = formatTables(document.getElementById('at_table').value||'');
            const duration = Number(toLatn(document.getElementById('at_duration').value||getDefaultDuration()));
            try{
              el?.setAttribute('aria-busy','true');
              await window.supabaseBridge.updateReservationSB(id, { table_no: table, duration_minutes: duration, status: 'assigned' });
              await window.supabaseBridge.syncAdminDataToLocal();
              render();
            }catch(e){ Modal?.info?.('تعذّر التعيين','خطأ'); }
            finally{ el?.removeAttribute?.('aria-busy'); }
          };
          const cancel = ()=> window.Modal?.hide?.();
          const ok = document.createElement('button'); ok.className='btn btn-primary'; ok.textContent='حفظ'; ok.onclick = async ()=>{ await save(); window.Modal.hide(); };
          const no = document.createElement('button'); no.className='btn btn-ghost'; no.textContent='إلغاء'; no.onclick = cancel;
          window.Modal?.show?.('تعيين طاولة', html, [ok, no]);
        },

        print(id){
          const r = listAll().find(x => String(x.id) === String(id));
          if (!r) return;

          const dt = splitDateTime(r.date);
          const brandName = LS.get('restaurantName', 'مطعم الذوق العربي');
          const esc = (s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

          const w = window.open('', '_blank', 'width=520,height=740');
          w.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">
            <title>إيصال حجز #${esc(r.id)}</title>
            <style>
              @page { margin: 16mm; }
              body{ font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial,'Tajawal',sans-serif; background:#fff; color:#111827; }
              .receipt{ border:2px dashed #e5e7eb; border-radius:16px; padding:18px; }
              .tag{ text-align:right; font-size:22px; font-weight:900; margin:0 0 4px; }
              .brand{ text-align:center; font-size:22px; font-weight:900; margin:6px 0 14px; }
              .pairs{ display:grid; grid-template-columns: max-content 1fr; column-gap:10px; row-gap:10px; align-items:baseline; justify-items:start; }
              .value{ text-align:right; font-weight:900; font-size:20px; }
              .label{ text-align:right; font-size:18px; color:#6b7280; }
              .notes{ margin-top:14px; }
              .notes-label{ color:#6b7280; margin-bottom:6px; }
              .notes-value{ font-size:18px; }
              hr{ border:0; border-top:1px solid #f1f5f9; margin:10px 0; }
              .muted{ color:#6b7280 }
            </style>
          </head><body>
            <div class="receipt">
              <div class="tag">إيصال حجز</div>
              <div class="brand">${esc(brandName)}</div>
              <div class="pairs">
                <div class="label">الاسم :</div><div class="value">${esc(r.name||'-')}</div>
                <div class="label">الهاتف :</div><div class="value">${esc(toLatn(r.phone||'-'))}</div>
                <div class="label">التاريخ :</div><div class="value">${esc(dt.d)}</div>
                <div class="label">الوقت :</div><div class="value">${esc(dt.t)}</div>
                <div class="label">الأشخاص :</div><div class="value">${fmtNum(r.people||1)}</div>
                <div class="label">الطاولة :</div><div class="value">${esc(formatTables(r.table||'') || '—')}</div>
                <div class="label">الحالة :</div><div class="value">${esc(statusLabel(r.status||'new'))}</div>
              </div>
              <div class="notes">
                <div class="notes-label">ملاحظات :</div>
                <div class="notes-value">${esc(r.notes||'—')}</div>
              </div>
            </div>
            <script>window.print();<\/script>
          </body></html>`);
          w.document.close();
        },

        async changeStatus(id, to){ await changeStatus(id, to); }
      };

      // events
      document.getElementById('refresh')?.addEventListener('click', async ()=>{
        try{ await window.supabaseBridge?.syncAdminDataToLocal?.(); }catch(e){}
        render();
      });

      // tabs
      const tabs = document.getElementById('resTabs');
      tabs?.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-tab]');
        if(!btn) return;
        tabs.querySelectorAll('.res-tab').forEach(b=> b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        R.tab = btn.getAttribute('data-tab') || 'all';
        R.page = 1; render();
      });

      // search
      const q = document.getElementById('q');
      q?.addEventListener('input', ()=>{ R.q = q.value||''; R.page = 1; render(); });

      // conflicts toggle
      document.getElementById('conflictsBtn')?.addEventListener('click', ()=>{ R.showConflicts = !R.showConflicts; R.page = 1; render(); });

      // paging
      const pageSizeSel = document.getElementById('pageSize');
      if (pageSizeSel) {
        pageSizeSel.value = String(R.size);
        pageSizeSel.addEventListener('change', ()=>{ R.size = Number(pageSizeSel.value)||10; LS.set('res_page_size', R.size); R.page=1; render(); });
      }
      document.getElementById('prevPage')?.addEventListener('click', ()=>{ if(R.page>1){ R.page--; render(); }});
      document.getElementById('nextPage')?.addEventListener('click', ()=>{
        const total = listAll().filter(r => R.tab==='all'?true:(r.status===R.tab)).filter(matchQuery).length;
        const pages = Math.max(1, Math.ceil(total / R.size));
        if (R.page < pages) { R.page++; render(); }
      });

      // add & export
      document.getElementById('addBtn')?.addEventListener('click', ()=>{
        openForm('إضافة حجز جديد', { status:'new', people:2, duration:getDefaultDuration() }, async (data)=>{
          try{
            const iso = data.iso || (data.date ? new Date(data.date).toISOString() : new Date().toISOString());
            await window.supabaseBridge.createReservationSB({
              name:data.name, phone:data.phone, iso, people:data.people,
              kind:'table', table:data.table||'', notes:data.notes, duration_minutes:data.duration||getDefaultDuration()
            });
            await window.supabaseBridge.syncAdminDataToLocal();
            R.page = 1; render();
          }catch(e){
            Modal?.info?.('تعذّر الإضافة<br><div class="small muted">'+(e?.message||e)+'</div>','خطأ');
          }
        });
      });

      document.getElementById('exportBtn')?.addEventListener('click', ()=>{
        const rows = [['id','name','phone','date','people','table','status','notes','duration'].join(',')];
        listAll().forEach(r=>{
          rows.push([r.id,(r.name||''),(r.phone||''),(r.date||''),(r.people||0),(r.table||''),(r.status||'new'),(r.notes||''),(r.duration||'')].map(v=>{
            const s=String(v??''); return /[,"\n]/.test(s) ? ('"'+s.replace(/"/g,'""')+'"') : s;
          }).join(','));
        });
        const blob = new Blob([rows.join('\n')], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'reservations.csv'; a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 500);
      });

      // live refresh hooks
      window.addEventListener('storage', (e)=>{ if(e.key==='reservations') render(); });
      document.addEventListener('sb:admin-synced', ()=> render());

      // init
      if (document.readyState !== 'loading') render();
      else document.addEventListener('DOMContentLoaded', render);
    })();
  </script>
</body>
</html>
