<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- Supabase: ضع مفاتيح مشروعك -->
<script>
  window.SUPABASE_URL  = "https://ivotznbljtzjdmlsyqcq.supabase.co";
  window.SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ...CI6MjA3MjMyMzIzOX0.umCkEdzG0B7hEMJEg6eRMQEBzWHypLaREfxxjkuo_uw";
</script>

<!-- عميل Supabase -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
</script>
<script type="module">
  const ch = window.supabase
    .channel('live', { config: { broadcast: { self: true } } })
    .on('broadcast', { event: 'new-order' }, async () => {
      // أعِد المحاولة إلى أن يتوفر الجسر ثم مزامنة فورية
      const trySync = async (tries = 10) => {
        if (window.supabaseBridge?.syncAdminDataToLocal) {
          try { await window.supabaseBridge.syncAdminDataToLocal(); } catch(e){ console.error(e); }
        } else if (tries > 0) {
          setTimeout(() => trySync(tries - 1), 300); // إعادة محاولة كل 300ms
        }
      };
await trySync(); try { updateAll(); } catch (e) {}
    });

  await ch.subscribe();
  window.__ADM_LIVE = ch;
</script>

<!-- جسر Supabase الذي حمّلته -->
<script type="module" src="supabase-bridge.js"></script>

<!-- مزامنة الكتالوج للـlocalStorage قبل script.js -->
<script type="module">
  import { syncPublicCatalogToLocal } from './supabase-bridge.js';
  await syncPublicCatalogToLocal();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم المطعم</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Mini KDS styles for Salla section */
    .kds-grid{display:grid;gap:16px;grid-template-columns:repeat(3, minmax(0,1fr))}
    @media (max-width:1100px){.kds-grid{grid-template-columns:repeat(2, minmax(0,1fr))}}
    @media (max-width:700px){.kds-grid{grid-template-columns:1fr}}
    .kds-card{background:#fff;border:1px solid #eef2f7;border-radius:16px;box-shadow:var(--shadow)}
    .kds-card .hdr{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef2f7}
    .kds-card .body{padding:8px 12px}
    .kds-card .kds-items{display:flex;flex-direction:column;gap:4px;margin-top:6px}
    .kds-muted{color:#6b7280}
    .kds-card .kds-meter{height:6px;background:#f3f4f6;border-radius:999px;margin:8px 12px;overflow:hidden}
    .kds-card .kds-meter span{display:block;height:100%;background:#10b981}
    .kds-foot{display:flex;gap:8px;justify-content:flex-end;padding:10px 12px;border-top:1px solid #eef2f7}
    .kds-card .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#f3f4f6;color:#374151;font-weight:800;font-size:.85rem}
    .salla-opts{display:flex;gap:8px;flex-wrap:wrap}
    /* Tiny dashboard cards */
    .tiny-kpis{display:grid;grid-template-columns:repeat(5, minmax(0,1fr));gap:12px}
    @media(max-width:1100px){.tiny-kpis{grid-template-columns:repeat(3, minmax(0,1fr))}}
    @media(max-width:700px){.tiny-kpis{grid-template-columns:repeat(2, minmax(0,1fr))}}
    .tiny-kpi{background:#fff;border:1px solid #eef2f7;border-radius:12px;padding:12px}
    .tiny-kpi .val{font-size:1.2rem;font-weight:900}
    /* Ratings: inline stars */
    .stars-sm{display:inline-flex;gap:4px;align-items:center}
    .stars-sm .s{width:14px;height:14px;display:inline-block}
    .stars-sm .s::before{content:'★';display:block;line-height:1;font-size:14px;color:var(--star,#f59e0b)}
    .stars-sm .s.off::before{color:#e5e7eb}
    /* Shared bits */
    .muted{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .ops-inline{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;overflow-x:auto;padding-bottom:2px}
    .col-ops{width:1%;white-space:nowrap}
    .vis-note{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:10px 12px}
    /* Show only dashboard section on this page */
    main > section{display:none}
    main > section#dashboard{display:block}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container row">
      <div class="brand">لوحة تحكم المطعم</div>
      <div class="nav-actions">
        <button id="logoutBtn" class="btn btn-ghost">تسجيل الخروج</button>
        <a href="index.html" class="btn btn-ghost">عرض الموقع</a>
        <button id="refresh" class="btn btn-primary">تحديث</button>
        <div class="icon-btn" id="notifyBtn" title="الإشعارات">
          <span id="notifCount" class="icon-badge" style="display:none">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.4-1.4A2 2 0 0118 14.17V11a6 6 0 00-12 0v3.17a2 2 0 01-.6 1.43L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
        </div>
      </div>
    </div>
  </nav>

  <div class="admin-layout">
    <aside class="sidebar">
      <h3>المعلومات</h3>
      <a class="side-link active" href="admin.html" aria-current="page">لوحة المعلومات</a>
      <a class="side-link" href="admin-orders.html">إدارة الطلبات</a>
      <a class="side-link" href="admin-menu.html">إدارة المنيو</a>
      <a class="side-link" href="admin-cats.html">إدارة الأقسام</a>
      <a class="side-link" href="admin-ratings.html">إدارة التقييمات</a>
      <a class="side-link" href="admin-reports.html">التقارير</a>
      <a class="side-link" href="admin-reservations.html">معلومات الحجوزات</a>

      <div class="section">
        <div class="notice small">تصلك الإشعارات هنا بشكل فوري عند تنفيذ طلب جديد أو عند إضافة تقييم.</div>
      </div>
    </aside>

    <main class="main">
      <section id="dashboard" class="section">
        <div class="grid">
          <div class="card" style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h2 style="margin:0">نظرة عامة</h2>
              <button id="clearCache" class="btn btn-ghost">تفريغ الكاش</button>
            </div>
            <div class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr))">
              <div>
                <div class="small" style="color:var(--muted)">إجمالي المبيعات</div>
                <h2 id="totalSales" style="margin:0">0</h2>
              </div>
              <div>
                <div class="small" style="color:var(--muted)">الطلبات</div>
                <h2 id="totalOrders" style="margin:0">0</h2>
              </div>
              <div>
                <div class="small" style="color:var(--muted)">بانتظار المعالجة</div>
                <h2 id="pendingCount" style="margin:0">0</h2>
              </div>
              <div>
                <div class="small" style="color:var(--muted)">متوسط التقييم العام</div>
                <h2 id="avgRating" style="margin:0">0.0</h2>
                <div class="small" id="ratingsCount" style="color:var(--muted)">0+</div>
              </div>
            </div>
          </div>

          <div class="card" style="padding:16px">
            <h3>أعلى الأطباق خلال الأسبوع</h3>
            <div id="topDishes" class="small" style="color:var(--muted)">—</div>
          </div>

          <!-- Salla Orders (Mini KDS) -->
          <div class="card" style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px">
              <h3 style="margin:0">طلبات سلة (سريع)</h3>
              <div class="salla-opts">
                <button id="demoOrder" class="btn btn-ghost">إنشاء طلب عيّنة +</button>
                <button id="groupBtn" class="btn btn-ghost">تجميع الأصناف</button>
                <div class="kds-search"><input id="searchOrders" class="input" placeholder="بحث: رقم/اسم/طاولة/صنف" /></div>
              </div>
            </div>
            <div class="tiny-kpis" style="margin-bottom:12px">
              <div class="tiny-kpi"><div class="small muted">جديد</div><div id="cnt-new" class="val mono">0</div></div>
              <div class="tiny-kpi"><div class="small muted">قيد التحضير</div><div id="cnt-received" class="val mono">0</div></div>
              <div class="tiny-kpi"><div class="small muted">جاهز</div><div id="cnt-preparing" class="val mono">0</div></div>
              <div class="tiny-kpi"><div class="small muted">مُسلّم</div><div id="cnt-delivered" class="val mono">0</div></div>
              <div class="tiny-kpi"><div class="small muted">ملغي</div><div id="cnt-canceled" class="val mono">0</div></div>
            </div>
            <div class="kds-grid"><div class="small" style="color:var(--muted)">لا يوجد بيانات</div></div>
          </div>

          <!-- Reservations Mini -->
          <div class="card" style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3 style="margin:0">الحجوزات (مختصر)</h3>
              <a class="btn btn-ghost" href="admin-reservations.html">فتح الحجوزات</a>
            </div>
            <div class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr));gap:10px">
              <div class="tiny-kpi">
                <div class="small muted">بانتظار التأكيد</div>
                <div id="r_new" class="val mono">0</div>
              </div>
              <div class="tiny-kpi">
                <div class="small muted">مؤكد</div>
                <div id="r_confirmed" class="val mono">0</div>
              </div>
              <div class="tiny-kpi">
                <div class="small muted">جلس</div>
                <div id="r_seated" class="val mono">0</div>
              </div>
              <div class="tiny-kpi">
                <div class="small muted">ملغي</div>
                <div id="r_canceled" class="val mono">0</div>
              </div>
            </div>
            <div id="resvSummary" class="small muted" style="margin-top:8px">—</div>
            <div class="table-card" style="margin-top:12px">
              <table class="table-soft">
                <thead><tr><th>#</th><th>الاسم</th><th>الهاتف</th><th>التاريخ</th><th>الحالة</th></tr></thead>
                <tbody id="miniResBody"><tr><td colspan="5" class="small muted">لا يوجد بيانات حتى الآن</td></tr></tbody>
              </table>
            </div>
          </div>

          <div class="card" style="padding:16px">
            <h3>الإشعارات</h3>
            <div id="notifList"></div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="markAllRead" class="btn btn-primary">تمييز الكل كمقروء</button>
              <button id="clearNotifs" class="btn btn-ghost">مسح الإشعارات</button>
            </div>
          </div>

          <div class="card" style="padding:16px">
            <h3>الكتالوج (مختصر)</h3>
            <div class="table-card">
              <table class="table-soft">
                <thead><tr><th>القسم</th><th>العناصر</th><th>متوسط</th><th class="col-ops">عمليات</th></tr></thead>
                <tbody id="miniMenuBody"><tr><td colspan="4" class="small muted">لا يوجد عناصر</td></tr></tbody>
              </table>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <a class="btn btn-primary" href="admin-menu.html">إدارة المنيو</a>
              <a class="btn btn-ghost" href="admin-cats.html">إدارة الأقسام</a>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Notifications Drawer (simple) -->
  <aside class="drawer" id="notifDrawer" aria-hidden="true" style="width:420px">
    <div class="head">
      <strong>الإشعارات</strong>
      <button class="btn btn-ghost" id="closeNotif">إغلاق</button>
    </div>
    <div class="body"><div id="notifSummary" class="small" style="margin-bottom:8px;color:var(--muted)"></div><div id="notifListDrawer"></div></div>
    <div class="totals">
      <button id="markAllRead" class="btn btn-primary">تمييز الكل كمقروء</button>
    </div>
  </aside>

  <script src="admin.js"></script>
  <script src="admin-multipage.js"></script>

  <script>
(function(){
  // Helpers
  const LS = window.LS || { get:(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch{ return d } }, set:(k,v)=> localStorage.setItem(k, JSON.stringify(v)) };
  const setText = window.setText || ((sel,v)=>{ const el=document.querySelector(sel); if(el) el.textContent=String(v??''); });
  const setHTML = window.setHTML || ((sel,html)=>{ const el=document.querySelector(sel); if(el) el.innerHTML = html ?? ''; });

  // Clear cache
  const clearBtn = document.getElementById('clearCache');
  if (clearBtn) clearBtn.addEventListener('click', ()=>{
    ['categories','menuItems','orders','ratings','notifications','reservations'].forEach(k=> localStorage.removeItem(k));
    try{ updateAll(); }catch(e){}
  });

  // ===== Dashboard mini kpis =====
  function fmt(n){ return new Intl.NumberFormat('ar-EG').format(Number(n)||0); }
  function updateMiniKPIs(){
    const orders = LS.get('orders', []).filter(o => o.source !== 'demo');
    const totalSales = orders.reduce((a,b)=> a+(Number(b.total)||0), 0);
    const pending = orders.filter(o=>o.status==='new').length;

    const items = LS.get('menuItems', []);
    let allAvg = 0, allCount = 0;
    items.forEach(it=>{
      if(it.rating){
        const c = Number(it.rating.count)||0, a = Number(it.rating.avg)||0;
        allAvg += a*c; allCount += c;
      }
    });
    const avg = allCount ? allAvg / allCount : 0;

    setText('#totalSales', fmt(totalSales));
    setText('#pendingCount', fmt(pending));
    setText('#totalOrders', fmt(orders.length));
    setText('#avgRating', (avg||0).toFixed(1));
    setText('#ratingsCount', (allCount||0) + '+');

    // week top dishes
    const weekStart = new Date(); weekStart.setDate(weekStart.getDate()-7);
    const map = {};
    orders.filter(o=>{ const t=o.time? new Date(o.time):null; return t && t>=weekStart; })
      .forEach(o=>{
        (o.items||[]).forEach(it=>{
          const name = it?.name ?? 'غير مسمى';
          const qty = Number(it?.qty)||0;
          map[name] = (map[name]||0) + qty;
        });
      });
    const top = Object.entries(map).sort((a,b)=> b[1]-a[1]).slice(0,5);
    setText('#topDishes', top.length ? top.map(([n,q])=> `${n} × ${q}`).join('، ') : 'لا يوجد بيانات بعد');
  }

  // ===== Reservations mini =====
  function updateMiniReservations(){
    const res = LS.get('reservations', []);
    const newC = res.filter(r=>(r?.status||'new')==='new').length;
    const conf = res.filter(r=> r.status==='confirmed').length;
    const seat = res.filter(r=> r.status==='seated').length;
    const canc = res.filter(r=> r.status==='canceled' || r.status==='cancelled').length;
    document.getElementById('r_new').textContent = newC;
    document.getElementById('r_confirmed').textContent = conf;
    document.getElementById('r_seated').textContent = seat;
    document.getElementById('r_canceled').textContent = canc;

    const body = document.getElementById('miniResBody');
    if(!body) return;
    const rows = res.slice(0,8).map(r=>{
      const d = new Date(r.date).toLocaleString('ar-EG');
      const st = r.status || 'new';
      return `<tr><td class="mono">#${r.id}</td><td>${r.name||'-'}</td><td>${r.phone||'-'}</td><td>${d}</td><td>${st}</td></tr>`;
    }).join('');
    body.innerHTML = rows || `<tr><td colspan="5" class="small muted">لا يوجد بيانات حتى الآن</td></tr>`;
    const sum = document.getElementById('resvSummary');
    if(sum) sum.textContent = `حجوزات — جديد: ${newC}، مؤكد: ${conf}، حاضر: ${seat}، ملغي: ${canc}`;
  }

  // ===== Salla mini KDS (read-only) =====
  const grid = document.querySelector('.kds-grid');
  const state = { tab:'all', q:'' };

  function itemsById(){
    const arr = LS.get('menuItems', []);
    const map={}; arr.forEach(i=> map[i.id]=i); return map;
  }
  function updateCounts(){
    const orders = LS.get('orders', []);
    const cNew = orders.filter(o=>o.status==='new').length;
    const cRec = orders.filter(o=>o.status==='received').length;
    const cPrep= orders.filter(o=>o.status==='preparing').length;
    const cDel = orders.filter(o=>o.status==='delivered').length;
    const cCan = orders.filter(o=>o.status==='canceled').length;
    document.getElementById('cnt-new').textContent = cNew;
    document.getElementById('cnt-received').textContent = cRec;
    document.getElementById('cnt-preparing').textContent = cPrep;
    document.getElementById('cnt-delivered').textContent = cDel;
    document.getElementById('cnt-canceled').textContent = cCan;
  }
  function matchQuery(o, map){
    const q = state.q.trim();
    if(!q) return true;
    if(('#'+o.id).includes(q)) return true;
    if((o.orderName||'').includes(q)) return true;
    if((o.table||'').toString().includes(q)) return true;
    return o.items?.some(it => (map[it.itemId]?.name||'').includes(q));
  }
  function meterColor(s){ return s==='new'?'#f97316': s==='received'?'#3b82f6': s==='preparing'?'#10b981': s==='canceled'?'#ef4444':'#9ca3af'; }
  function statusClass(s){ return s==='new'?'kds-new': s==='received'?'kds-received': s==='preparing'?'kds-preparing': s==='canceled'?'kds-canceled':'kds-delivered'; }
  function renderKDS(){
    if(!grid) return;
    const orders = LS.get('orders', []);
    const map = itemsById();
    updateCounts();
    const filtered = orders.filter(o => (state.tab==='all' ? true : o.status===state.tab))
                           .filter(o => matchQuery(o, map));
    if(filtered.length===0){ grid.innerHTML = '<div class="small" style="color:var(--muted)">لا يوجد طلبات مطابقة.</div>'; return; }
    grid.innerHTML = filtered.map(o=>{
      const prog = Math.min(100, (o.status==='new'?15: o.status==='received'?50: o.status==='preparing'?85:100));
      const statusCls = statusClass(o.status);
      const mc = meterColor(o.status);
      const title = (o.items?.[0]?.name || 'طلب');
      const itemLines = (o.items||[]).map(it=>{
        const nm = (map[it.itemId]?.name)||it.name||'عنصر';
        return `<div class="it"><div>${nm}</div><div class="kds-muted">× ${Number(it.qty)||0}</div></div>`;
      }).join('');
      return `<div class="kds-card ${statusCls}" data-id="${o.id}">
        <div class="hdr">
          <div class="left">
            <div class="kds-muted">#${o.id}</div>
            <span class="chip">${o.table? 'طاولة ' + o.table : 'سفري'}</span>
            ${o.status==='delivered'?'<span class="chip">مُسلّم</span>': (o.status==='canceled'?'<span class="chip">ملغي</span>':'')}
          </div>
          <div class="kds-muted">${new Date(o.time||o.createdAt||Date.now()).toLocaleString('ar-EG')}</div>
        </div>
        <div class="body">
          <div class="row" style="display:flex;justify-content:space-between;align-items:center">
            <div class="title">${o.orderName || title}</div>
            <div class="kds-muted">العناصر: ${o.itemCount ?? (o.items? o.items.reduce((a,b)=>a+(b.qty||0),0) : 0)}</div>
          </div>
          <div class="kds-items">${itemLines}</div>
          ${o.notes ? `<div style="margin-top:6px;color:var(--muted);font-size:.9rem">ملاحظات: ${o.notes}</div>` : ``}
        </div>
        <div class="kds-meter"><span style="width:${prog}%; background:${mc}"></span></div>
        <div class="kds-foot">
          <button class="btn btn-ghost" onclick="printOrder(${o.id})">طباعة</button>
          <button class="btn btn-ghost" onclick="cancelOrDelete(${o.id})">حذف/إلغاء</button>
          <button class="btn btn-ghost" onclick="editOrder(${o.id})">تعديل</button>
        </div>
      </div>`;
    }).join('');
  }

  // Query
  const qEl = document.getElementById('searchOrders');
  if(qEl) qEl.addEventListener('input', ()=>{ state.q = qEl.value||''; renderKDS(); });

  // Group modal (from admin-orders)
  window.groupModal = {
    open(){
      const orders = LS.get('orders', []);
      const map = {};
      orders.forEach(o=>{
        (o.items||[]).forEach(it=>{
          const key = it.name || it.itemId || 'غير مسمى';
          map[key] = (map[key]||0) + (Number(it.qty)||0);
        });
      });
      const html = Object.entries(map).map(([n,q])=> `<div>${n} <span class="kds-muted">× ${q}</span></div>`).join('');
      const body = `<div class="card" style="padding:16px;background:#fff;color:#111"><h3 style="margin-top:0">تجميع الأصناف</h3>${html||'<div class="small kds-muted">لا يوجد بيانات</div>'}</div>`;
      if(window.showModal) showModal({title:'تجميع الأصناف', bodyHTML:body, actions:[{label:'إغلاق', className:'btn btn-ghost', onClick:()=> hideModal()}]});
      else alert('لا يوجد مودال عام متاح الآن.');
    }
  };
  const gBtn = document.getElementById('groupBtn');
  if(gBtn) gBtn.addEventListener('click', ()=> groupModal.open());

  // Demo order
  const demoBtn = document.getElementById('demoOrder');
  if(demoBtn) demoBtn.addEventListener('click', ()=>{
    const orders = LS.get('orders', []);
    const id = Date.now()%100000;
    orders.unshift({
      id,
      total: 100,
      itemCount: 2,
      time: new Date().toISOString(),
      status: 'new',
      items: [{name:'فتوش', qty:1, price:50}, {name:'كباب', qty:1, price:50}],
      table: '1',
      orderName: 'طلب تجربة'
    });
    LS.set('orders', orders);
    renderKDS();
    try{ updateAll(); }catch(e){}
  });

  // Notifications glue
  function renderNotifs(){
    const box = document.getElementById('notifList');
    const box2= document.getElementById('notifListDrawer');
    const ns = LS.get('notifications', []);
    const html = ns.length ? ns.map(n=> `<div class="notice small" style="display:flex;justify-content:space-between;gap:10px"><div><strong>${n.title||'-'}</strong><div class="muted">${n.message||''}</div></div><div class="muted mono">${new Date(n.time||Date.now()).toLocaleString('ar-EG')}</div></div>`).join('') : '<div class="small muted">لا يوجد إشعارات</div>';
    if(box) box.innerHTML = html;
    if(box2) box2.innerHTML = html;
    const sum = document.getElementById('notifSummary');
    if(sum){
      const orders = LS.get('orders', []).filter(o=>o.status!=='delivered');
      const counts = { new: orders.filter(o=>o.status==='new').length, received: orders.filter(o=>o.status==='received').length, preparing: orders.filter(o=>o.status==='preparing').length, delivered: orders.filter(o=>o.status==='delivered').length };
      sum.textContent = `الطلبات النشطة: ${counts.new+counts.received+counts.preparing} — جديد: ${counts.new}، قيد التحضير: ${counts.received}، جاهز: ${counts.preparing}، مُسلّم: ${counts.delivered}`;
    }
  }

  // Global updateAll for dashboard
  window.updateAll = function(){
    try{ updateMiniKPIs(); }catch(e){}
    try{ updateMiniReservations(); }catch(e){}
    try{ renderKDS(); }catch(e){}
    try{ renderNotifs(); }catch(e){}
  };

  // Init
  updateAll();
  window.addEventListener('storage', (e)=> {
    if (!e || !e.key || ['notifications','orders','menuItems','ratings','categories','reservations'].includes(e.key)) updateAll();
  });
})();
  </script>
</body>
</html>
