<!-- Cleaned from source admin-reports.html  :contentReference[oaicite:0]{index=0} -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- Supabase project keys -->
  <script>
    window.SUPABASE_URL  = "https://ivotznbljtzjdmlsyqcq.supabase.co";
    window.SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2b3R6bmJsanR6amRtbHN5cWNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDcyMzksImV4cCI6MjA3MjMyMzIzOX0.umCkEdzG0B7hEMJEg6eRMQEBzWHypLaREfxxjkuo_uw";
  </script>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
  </script>

  <!-- Live channel to refresh local data on broadcasts -->
  <script type="module">
    const ch = window.supabase
      .channel('live', { config: { broadcast: { self: true } } })
      .on('broadcast', { event: 'new-order' }, async () => {
        const trySync = async (tries = 10) => {
          if (window.supabaseBridge?.syncAdminDataToLocal) {
            try { await window.supabaseBridge.syncAdminDataToLocal(); } catch (e) { console.error(e); }
          } else if (tries > 0) {
            setTimeout(() => trySync(tries - 1), 300);
          }
        };
        await trySync();
        try { updateAll(); } catch (_) {}
      });

    await ch.subscribe();
    window.__ADM_LIVE = ch;
  </script>

  <!-- Supabase bridge -->
  <script type="module" src="supabase-bridge.js"></script>

  <!-- Preload public catalog into localStorage -->
  <script type="module">
    import { syncPublicCatalogToLocal } from "./supabase-bridge.js";
    await syncPublicCatalogToLocal();
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم المطعم – التقارير</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Auth Guard -->
  <script type="module">
    import { requireAdminOrRedirect, syncAdminDataToLocal } from "./supabase-bridge.js";
    await requireAdminOrRedirect('login.html');
    await syncAdminDataToLocal();
  </script>

  <!-- Page-only styles -->
  <style>
    /* Show only this page section */
    main > section { display: none; }
    main > section#reports { display: block; }

    /* Delta badge */
    .delta { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-weight: 800; font-size: .85rem; }
    .delta.up { color: #047857; background: #ecfdf5; }
    .delta.down { color: #b91c1c; background: #fef2f2; }

    /* Inline custom range */
    .inline-range { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .inline-range .input { height: 36px; }

    /* Mini table */
    .mini-table { width: 100%; border-collapse: collapse; }
    .mini-table thead th { font-weight: 900; color: var(--muted); font-size: .9rem; text-align: right; padding: 6px 0; border-bottom: 1px solid #eee; }
    .mini-table td { padding: 8px 0; border-bottom: 1px dashed #eee; text-align: right; }
    .muted { color: var(--muted); }
  </style>
</head>

<body>
  <!-- Top Navbar -->
  <nav class="navbar" role="navigation" aria-label="الشريط العلوي">
    <div class="container row">
      <div class="brand">لوحة تحكم المطعم</div>
      <div class="nav-actions">
        <button id="logoutBtn" class="btn btn-ghost" type="button">تسجيل الخروج</button>
        <a href="index.html" class="btn btn-ghost">عرض الموقع</a>
        <button class="icon-btn" id="notifyBtn" title="الإشعارات" aria-controls="notifDrawer" aria-expanded="false" type="button">
          <span id="notifCount" class="icon-badge" style="display:none">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 17h5l-1.4-1.4A2 2 0 0118 14.17V11a6 6 0 00-12 0v3.17a2 2 0 01-.6 1.43L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="القائمة الجانبية">
      <h3>المعلومات</h3>
      <a class="side-link" href="admin.html">لوحة المعلومات</a>
      <a class="side-link" href="admin-orders.html">إدارة الطلبات</a>
      <a class="side-link" href="admin-menu.html">إدارة المنيو</a>
      <a class="side-link" href="admin-cats.html">إدارة الأقسام</a>
      <a class="side-link" href="admin-ratings.html">إدارة التقييمات</a>
      <a class="side-link active" href="admin-reports.html" aria-current="page">التقارير</a>
      <a class="side-link" href="admin-reservations.html">معلومات الحجوزات</a>

      <div class="section">
        <div class="notice small">
          تقارير بسيطة لمتابعة حالات الطلبات والأطباق الأعلى مبيعًا والحجوزات القريبة.
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main">
      <section id="reports" class="section card" style="padding:16px">
        <h3>التقارير</h3>

        <!-- Range controls -->
        <div class="row" style="justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 12px">
          <div id="rangeTabs" class="tabs">
            <button class="tab active" data-range="7">7 أيام</button>
            <button class="tab" data-range="30">30 يوم</button>
            <button class="tab" data-range="90">90 يوم</button>
            <button class="tab" data-range="365">سنة</button>
            <button class="tab" data-range="all">الكل</button>
          </div>

          <div class="inline-range">
            <input id="from" class="input" type="date" />
            <span>إلى</span>
            <input id="to" class="input" type="date" />
            <button id="applyRange" class="btn btn-olive" type="button">تطبيق</button>
            <button id="clearRange" class="btn btn-ghost" type="button">إلغاء</button>
          </div>

          <div class="row" style="gap:8px">
            <button id="expResCSV" class="btn btn-ghost" type="button" title="تصدير الحجوزات CSV">تصدير CSV</button>
            <button id="expResPDF" class="btn btn-ghost" type="button" title="تصدير الحجوزات PDF">تصدير PDF</button>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div class="card" style="padding:16px; min-height:300px">
            <h3>توزيع حالات الطلبات</h3>
            <canvas id="statusDonut" height="220" aria-label="توزيع حالات الطلبات"></canvas>
          </div>
          <div class="card" style="padding:16px; min-height:300px">
            <h3>أعلى 5 أطباق</h3>
            <canvas id="topItemsBar" height="220" aria-label="أعلى الأطباق"></canvas>
          </div>
        </div>

        <!-- Next 5 reservations -->
        <div class="card" style="padding:16px; margin-top:16px">
          <h3>أقرب 5 حجوزات</h3>
          <table class="mini-table" aria-label="أقرب الحجوزات">
            <thead>
              <tr>
                <th>الاسم</th>
                <th>الهاتف</th>
                <th>التاريخ</th>
              </tr>
            </thead>
            <tbody id="nextResTBody">
              <tr><td colspan="3" class="small muted">لا يوجد حجوزات قريبة الآن</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Notifications Drawer -->
  <aside class="drawer" id="notifDrawer" aria-hidden="true" style="width:420px">
    <div class="head">
      <strong>الإشعارات</strong>
      <button class="btn btn-ghost" id="closeNotif" type="button">إغلاق</button>
    </div>
    <div class="body">
      <div id="notifSummary" class="small" style="margin-bottom:8px;color:var(--muted)"></div>
      <div id="notifList"></div>
    </div>
    <div class="totals">
      <button id="markAllRead" class="btn btn-primary" type="button">تمييز الكل كمقروء</button>
    </div>
  </aside>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <script src="admin.js"></script>

  <script>
    (function () {
      // Local helpers (fallback if not provided globally by admin.js)
      const LS = window.LS || { get: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } } };
      const setText = window.setText || ((sel, v) => { const el = document.querySelector(sel); if (el) el.textContent = String(v ?? ''); });

      // EN formats (numbers/dates for exports)
      const nfmt = new Intl.NumberFormat('en-US');
      const dfmt = new Intl.DateTimeFormat('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
      const tfmt = new Intl.DateTimeFormat('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });

      // Range state
      const R = { range: '7', from: null, to: null };

      // Compute active range dates [start,end]
      function getRangeDates() {
        if (R.from && R.to) {
          const s = new Date(R.from); s.setHours(0, 0, 0, 0);
          const e = new Date(R.to);   e.setHours(23, 59, 59, 999);
          return [s, e];
        }
        if (R.range === 'all') return [null, null];
        const days = Number(R.range) || 7;
        const end = new Date(); end.setHours(23, 59, 59, 999);
        const start = new Date(end); start.setDate(start.getDate() - (days - 1)); start.setHours(0, 0, 0, 0);
        return [start, end];
      }

      // Previous period dates (same length, immediately before current)
      function getPrevRangeDates() {
        const [start, end] = getRangeDates();
        if (!start || !end) return [null, null];
        const span = end - start + 1;
        const prevEnd = new Date(start.getTime() - 1);
        const prevStart = new Date(prevEnd.getTime() - (span - 1));
        prevStart.setHours(0, 0, 0, 0);
        prevEnd.setHours(23, 59, 59, 999);
        return [prevStart, prevEnd];
      }

      // Orders within current/previous ranges
      function ordersInRange() {
        const all = LS.get('orders', []) || [];
        const [start, end] = getRangeDates();
        return all.filter(o => {
          const t = o.time ? new Date(o.time) : null;
          return t && (!start || t >= start) && (!end || t <= end);
        });
      }
      function ordersInPrevRange() {
        const all = LS.get('orders', []) || [];
        const [start, end] = getPrevRangeDates();
        if (!start || !end) return [];
        return all.filter(o => {
          const t = o.time ? new Date(o.time) : null;
          return t && t >= start && t <= end;
        });
      }

      // Summary KPIs (no-op if elements missing)
      function updateSummary() {
        const list = ordersInRange();
        const total = list.reduce((a, b) => a + (Number(b.total) || 0), 0);
        const count = list.length;
        const avg = count ? total / count : 0;

        setText('#k_total', nfmt.format(total.toFixed ? Number(total.toFixed(2)) : total));
        setText('#k_count', nfmt.format(count));
        setText('#k_avg', (avg || 0).toFixed(2));

        const prevTotal = ordersInPrevRange().reduce((a, b) => a + (Number(b.total) || 0), 0);
        const delta = prevTotal ? ((total - prevTotal) / prevTotal) * 100 : 0;
        const badge = document.querySelector('#k_total_delta');
        if (badge) {
          badge.className = 'delta ' + (delta >= 0 ? 'up' : 'down');
          badge.textContent = (delta >= 0 ? '▲ ' : '▼ ') + Math.abs(delta).toFixed(1) + '%';
        }
      }

      // Charts
      let statusDonut, topItemsBar;

      function drawDonut(list) {
        const map = { new: 0, received: 0, preparing: 0, delivered: 0, canceled: 0 };
        list.forEach(o => { map[o.status] = (map[o.status] || 0) + 1; });

        const ctx = document.getElementById('statusDonut');
        if (!ctx) return;
        if (statusDonut) statusDonut.destroy();
        statusDonut = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['جديد', 'قيد الاستلام', 'قيد التحضير', 'مُسلّم', 'ملغي'],
            datasets: [{ data: [map.new, map.received, map.preparing, map.delivered, map.canceled] }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      function drawTopItems(list) {
        const qtyByName = {};
        list.forEach(o => {
          (o.items || []).forEach(it => {
            const name = it?.name ?? 'عنصر';
            const qty = Number(it?.qty) || 0;
            qtyByName[name] = (qtyByName[name] || 0) + qty;
          });
        });
        const top = Object.entries(qtyByName).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const labels = top.map(([n]) => n);
        const values = top.map(([, q]) => q);

        const ctx = document.getElementById('topItemsBar');
        if (!ctx) return;
        if (topItemsBar) topItemsBar.destroy();
        topItemsBar = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [{ label: 'الكمية', data: values }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { ticks: { autoSkip: false } } }
          }
        });
      }

      // Next 5 reservations (soonest)
      function renderNextReservations() {
        const list = (LS.get('reservations', []) || []).filter(r => r.date).map(r => ({ ...r, _t: new Date(r.date) }))
          .filter(r => r._t >= new Date()).sort((a, b) => a._t - b._t).slice(0, 5);

        const tbody = document.getElementById('nextResTBody');
        if (!tbody) return;

        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="small muted">لا يوجد حجوزات قريبة الآن</td></tr>';
          return;
        }

        tbody.innerHTML = list.map(r => {
          const d = dfmt.format(r._t);
          const t = tfmt.format(r._t);
          return `<tr><td>${r.name || '—'}</td><td>${r.phone || '—'}</td><td>${d} ${t}</td></tr>`;
        }).join('');
      }

      // Exports
      function exportResCSV() {
        const [start, end] = getRangeDates();
        const rows = [['name', 'phone', 'date']];

        (LS.get('reservations', []) || [])
          .filter(r => {
            const t = new Date(r.date || 0);
            return (!start || t >= start) && (!end || t <= end);
          })
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .forEach(r => {
            const dt = r.date ? new Date(r.date) : null;
            rows.push([r.name || '', r.phone || '', dt ? (dfmt.format(dt) + ' ' + tfmt.format(dt)) : '']);
          });

        const csv = rows.map(row =>
          row.map(v => {
            const s = String(v ?? '');
            return /[,"\n]/.test(s) ? ('"' + s.replace(/"/g, '""') + '"') : s;
          }).join(',')
        ).join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'reservations.csv'; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 500);
      }

      function exportResPDF() {
        const [start, end] = getRangeDates();
        const list = (LS.get('reservations', []) || [])
          .filter(r => {
            const t = new Date(r.date || 0);
            return (!start || t >= start) && (!end || t <= end);
          })
          .sort((a, b) => new Date(a.date) - new Date(b.date));

        const brand = LS.get('restaurantName', 'مطعم الذوق العربي');
        const rows = list.map(r => {
          const dt = r.date ? new Date(r.date) : null;
          const d = dt ? dfmt.format(dt) : '-';
          const t = dt ? tfmt.format(dt) : '-';
          return `<tr><td>${r.name || '-'}</td><td>${r.phone || '-'}</td><td>${d} ${t}</td></tr>`;
        }).join('');

        const w = window.open('', '_blank', 'width=700,height=800');
        w.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">
          <title>تقرير الحجوزات</title>
          <style>
            @page { margin: 16mm; }
            body{ font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial,'Tajawal',sans-serif; background:#fff; color:#111827; }
            .brand{ text-align:center; font-size:22px; font-weight:900; margin:0 0 14px; }
            table{ width:100%; border-collapse:collapse }
            th,td{ padding:8px 0; border-bottom:1px solid #eee; text-align:right }
            thead th{ font-weight:900 }
          </style>
        </head><body>
          <div class="brand">${brand}</div>
          <table>
            <thead><tr><th>الاسم</th><th>الهاتف</th><th>التاريخ و الوقت</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="3" class="small">لا يوجد بيانات</td></tr>'}</tbody>
          </table>
          <script>window.print();<\/script>
        </body></html>`);
        w.document.close();
      }

      // Render all
      function render() {
        const list = ordersInRange();
        updateSummary();
        drawDonut(list);
        drawTopItems(list);
        renderNextReservations();
      }

      // Events
      document.getElementById('rangeTabs')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.tab'); if (!btn) return;
        document.querySelectorAll('#rangeTabs .tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        R.range = btn.dataset.range || '7';
        R.from = R.to = null;
        document.getElementById('from').value = '';
        document.getElementById('to').value = '';
        render();
      });

      document.getElementById('applyRange')?.addEventListener('click', () => {
        const f = document.getElementById('from')?.value || '';
        const t = document.getElementById('to')?.value || '';
        if (!f || !t) return;
        R.from = f; R.to = t; R.range = 'custom';
        document.querySelectorAll('#rangeTabs .tab').forEach(b => b.classList.remove('active'));
        render();
      });

      document.getElementById('clearRange')?.addEventListener('click', () => {
        R.from = R.to = null; R.range = '7';
        document.getElementById('from').value = '';
        document.getElementById('to').value = '';
        document.querySelectorAll('#rangeTabs .tab').forEach(b => b.classList.remove('active'));
        document.querySelector('#rangeTabs .tab[data-range="7"]')?.classList.add('active');
        render();
      });

      document.getElementById('expResCSV')?.addEventListener('click', exportResCSV);
      document.getElementById('expResPDF')?.addEventListener('click', exportResPDF);

      window.addEventListener('storage', (e) => {
        if (!e || !e.key) return;
        if (['orders', 'reservations', 'menuItems'].includes(e.key)) render();
      });

      // Initial render
      render();
    })();
  </script>

  <script src="admin-multipage.js"></script>

  <!-- Global App Modal -->
  <div id="appModal" class="modal" aria-hidden="true">
    <div class="card" style="padding:0;background:#fff;color:#111;max-width:min(560px,95vw)">
      <div class="head" style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #eee">
        <strong id="appModalTitle">إشعار</strong>
        <button class="btn btn-ghost" id="appModalClose" type="button">إغلاق</button>
      </div>
      <div class="body" id="appModalBody" style="padding:14px;max-height:60vh;overflow:auto"></div>
      <div class="actions" id="appModalActions" style="display:flex;gap:8px;justify-content:flex-start;padding:12px 14px;border-top:1px solid #eee"></div>
    </div>
  </div>
</body>
</html>
