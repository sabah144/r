<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- Supabase: ضع مفاتيح مشروعك -->
  <script>
    window.SUPABASE_URL  = "https://ivotznbljtzjdmlsyqcq.supabase.co";
    window.SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2b3R6bmJsanR6amRtbHN5cWNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDcyMzksImV4cCI6MjA3MjMyMzIzOX0.umCkEdzG0B7hEMJEg6eRMQEBzWHypLaREfxxjkuo_uw";
  </script>

  <!-- عميل Supabase -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
  </script>
  <script type="module">
    const ch = window.supabase
      .channel('live', { config: { broadcast: { self: true } } })
      .on('broadcast', { event: 'new-order' }, async () => {
        const trySync = async (tries = 10) => {
          if (window.supabaseBridge?.syncAdminDataToLocal) {
            try { await window.supabaseBridge.syncAdminDataToLocal(); } catch (e) { console.error(e); }
          } else if (tries > 0) {
            setTimeout(() => trySync(tries - 1), 300);
          }
        };
        await trySync();
        try { updateAll(); } catch (e) {}
      });

    ch.subscribe().catch(() => {});
    window.__ADM_LIVE = ch;
  </script>

  <!-- جسر Supabase الذي حمّلته -->
  <script type="module" src="supabase-bridge.js"></script>

  <!-- مزامنة الكتالوج للـlocalStorage قبل script.js -->
  <script type="module">
    import { syncPublicCatalogToLocal } from './supabase-bridge.js';
    syncPublicCatalogToLocal().catch(() => {});
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم المطعم - إدارة الطلبات (KDS)</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    .dot-canceled{ background:#ef4444 }
    .kds-canceled{ opacity:.9; box-shadow:0 0 0 2px rgba(239,68,68,.22) inset }
    .btn-danger{ background:#ef4444; color:#fff }
    .btn-danger.btn-ghost{ background:transparent; color:#ef4444; border:1px solid rgba(239,68,68,.35) }

    button[aria-busy="true"], .is-busy{
      pointer-events: none !important;
      opacity: .6 !important;
    }
  </style>

  <script type="module">
    import { requireAdminOrRedirect, syncAdminDataToLocal } from "./supabase-bridge.js";
    await requireAdminOrRedirect('login.html');
    await syncAdminDataToLocal();
  </script>
</head>
<body>
  <nav class="navbar">
    <div class="container row">
      <div class="brand">لوحة تحكم المطعم</div>
      <div class="nav-actions">
        <button id="logoutBtn" class="btn btn-ghost">تسجيل الخروج</button>
        <a href="index.html" class="btn btn-ghost">عرض الموقع</a>
        <button id="refresh" class="btn btn-primary">تحديث</button>
        <div class="icon-btn" id="notifyBtn" title="الإشعارات">
          <span id="notifCount" class="icon-badge" style="display:none">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.4-1.4A2 2 0 0118 14.17V11a6 6 0 00-12 0v3.17a2 2 0 01-.6 1.43L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
        </div>
      </div>
    </div>
  </nav>

  <div class="admin-layout">
    <aside class="sidebar">
      <h3>المعلومات</h3>
      <a class="side-link" href="admin.html">لوحة المعلومات</a>
      <a class="side-link" href="admin-orders.html">إدارة الطلبات</a>
      <a class="side-link" href="admin-menu.html">إدارة المنيو</a>
      <a class="side-link" href="admin-cats.html">إدارة الأقسام</a>
      <a class="side-link" href="admin-ratings.html">إدارة التقييمات</a>
      <a class="side-link" href="admin-reports.html">التقارير</a>
      <a class="side-link" href="admin-reservations.html">معلومات الحجوزات</a>

      <div class="section">
        <div class="notice small">
          تصلك الإشعارات هنا بشكل فوري عند تنفيذ طلب جديد أو عند إضافة تقييم.
        </div>
      </div>
    </aside>

    <main class="main">
      <section id="orders" class="section card" style="padding:16px">
        <div class="kds-head">
          <div class="kds-tabs" id="kdsTabs">
            <button data-st="all" class="kds-tab active"><span class="dot dot-new"></span>الكل</button>
            <button data-st="new" class="kds-tab"><span class="dot dot-new"></span><span>جديد</span><span id="cnt-new" class="badge badge-muted small">0</span></button>
            <button data-st="received" class="kds-tab"><span class="dot dot-received"></span><span>قيد التحضير</span><span id="cnt-received" class="badge badge-muted small">0</span></button>
            <button data-st="preparing" class="kds-tab"><span class="dot dot-preparing"></span><span>جاهز</span><span id="cnt-preparing" class="badge badge-muted small">0</span></button>
            <button data-st="delivered" class="kds-tab"><span class="dot dot-delivered"></span><span>مُسلّم</span><span id="cnt-delivered" class="badge badge-muted small">0</span></button>
            <button data-st="canceled" class="kds-tab"><span class="dot dot-canceled"></span><span>الإلغائات</span><span id="cnt-canceled" class="badge badge-muted small">0</span></button>
          </div>
          <div class="kds-actions">
            <button id="demoOrder" class="btn btn-ghost">انشاء طلب  +</button>
            <button id="groupBtn" class="btn btn-ghost">تجميع الأصناف</button>
            <div class="kds-search">
              <input id="searchOrders" class="input" placeholder="بحث: رقم/اسم/طاولة/صنف" />
            </div>
          </div>
        </div>

        <div id="kdsGrid" class="kds-grid"></div>
      </section>

      <!-- hidden table to keep admin.js happy (no crash) -->
      <section style="display:none">
        <table class="table" id="ordersTable"><thead><tr><th></th></tr></thead><tbody></tbody></table>
      </section>
    </main>
  </div>

  <!-- Modal: group items -->
  <div id="groupModal" class="modal" aria-hidden="true">
    <div class="card" style="padding:16px;background:#fff;color:#111">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">تجميع الأصناف (الطلبات النشطة)</h3>
        <button id="closeGroup" class="btn btn-ghost">إغلاق</button>
      </div>
      <div id="groupBody" class="small" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Notifications Drawer (reuse) -->
  <aside class="drawer" id="notifDrawer" aria-hidden="true" style="width:420px">
    <div class="head">
      <strong>الإشعارات</strong>
      <button class="btn btn-ghost" id="closeNotif">إغلاق</button>
    </div>
    <div class="body"><div id="notifSummary" class="small" style="margin-bottom:8px;color:var(--muted)"></div><div id="notifList"></div></div>
    <div class="totals">
      <button id="markAllRead" class="btn btn-primary">تمييز الكل كمقروء</button>
    </div>
  </aside>

  <!-- سكربت KDS مُغلّف لتجنّب تعارض المتغيّرات مع admin.js -->
  <script>
    (function(){
      'use strict';
      /* ===== KDS logic ===== */

      const LOCALE_LATN = 'ar-EG-u-nu-latn';
      const fmt = n => new Intl.NumberFormat(LOCALE_LATN).format(Number(n)||0);
      const dateFmt = iso => new Date(iso).toLocaleString(LOCALE_LATN);

      const LS = { get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
      const nowISO = () => new Date().toISOString();
      const itemsById = ()=>{ const arr=LS.get('menuItems',[]); const map={}; arr.forEach(i=>map[i.id]=i); return map; };
      const timeSince = (iso)=>{ const d=(Date.now()-new Date(iso).getTime())/1000|0; const m=(d/60)|0; const s=d%60; const mm = (m<10?'0':'')+m; const ss=(s<10?'0':'')+s; return mm+':'+ss };

      const statusClass = s =>
        s==='new'?'kds-new':
        s==='received'?'kds-received':
        s==='preparing'?'kds-preparing':
        s==='canceled'?'kds-canceled':'kds-delivered';

      const meterColor = s =>
        s==='new'?'#f97316':
        s==='received'?'#3b82f6':
        s==='preparing'?'#10b981':
        s==='canceled'?'#ef4444':'#9ca3af';

      const nextAction = s => s==='new'?'بدء التحضير': s==='received'?'جاهز':'تسليم';
      const statusToNext = s => s==='new'?'received': s==='received'?'preparing':'delivered';

      const state = { tab: 'all', q: '' };

      function updateCounts(){
        const orders = LS.get('orders', []);
        const cNew = orders.filter(o=>o.status==='new').length;
        const cRec = orders.filter(o=>o.status==='received').length;
        const cPrep = orders.filter(o=>o.status==='preparing').length;
        const cDel = orders.filter(o=>o.status==='delivered').length;
        const cCan = orders.filter(o=>o.status==='canceled').length;
        document.getElementById('cnt-new').textContent = fmt(cNew);
        document.getElementById('cnt-received').textContent = fmt(cRec);
        document.getElementById('cnt-preparing').textContent = fmt(cPrep);
        document.getElementById('cnt-delivered').textContent = fmt(cDel);
        const cc = document.getElementById('cnt-canceled'); if(cc) cc.textContent = fmt(cCan);
      }

      function matchQuery(o, map){
        const q = state.q.trim();
        if(!q) return true;
        if(('#'+o.id).includes(q)) return true;
        if((o.orderName||'').includes(q)) return true;
        if((o.table||'').toString().includes(q)) return true;
        return o.items?.some(it => (map[it.itemId]?.name||'').includes(q));
      }

      function renderKDS(){
        const grid = document.getElementById('kdsGrid');
        const orders = LS.get('orders', []);
        const map = itemsById();
        updateCounts();

        const filtered = orders.filter(o => (state.tab==='all' ? true : o.status===state.tab))
                               .filter(o => matchQuery(o, map));

        if(filtered.length===0){
          grid.innerHTML = '<div class="small" style="color:var(--muted)">لا يوجد طلبات مطابقة.</div>';
          return;
        }

        grid.innerHTML = filtered.map(o=>{
          const prog = Math.min(100, (o.status==='new'?15: o.status==='received'?50: o.status==='preparing'?85:100));
          const statusCls = statusClass(o.status);
          const mc = meterColor(o.status);
          const title = (o.items?.[0]?.name || 'طلب');
          const itemLines = (o.items||[]).map(it=>{
            const nm = (map[it.itemId]?.name)||it.name||'عنصر';
            return `<div class="it"><div>${nm}</div><div class="kds-muted">× ${fmt(it.qty)}</div></div>`;
          }).join('');

          const addsSum = (o.additions && o.additions.length) ? o.additions.reduce((a,b)=>a+(Number(b.price)||0),0) : 0;
          const discPct = Number(o.discountPct||0);

          return `<div class="kds-card ${statusCls}" data-id="${o.id}">
            <div class="hdr">
              <div class="left">
                <div class="time" title="${dateFmt(o.time)}">${timeSince(o.time)}</div>
                <span class="chip">${o.table? 'طاولة ' + fmt(o.table) : 'سفري'}</span>
                ${o.source==='salla' ? '<span class="chip">سلة</span>' : ''}
                ${o.status==='delivered'?'<span class="chip">مُسلّم</span>': (o.status==='canceled'?'<span class="chip">ملغي</span>':'')}
              </div>
              <div class="kds-muted">#${fmt(o.id)}</div>
            </div>
            <div class="body">
              <div class="row">
                <div class="title">${o.orderName || title}</div>
                <div class="kds-muted">العناصر: ${fmt(o.itemCount ?? (o.items? o.items.reduce((a,b)=>a+(b.qty||0),0) : 0))}</div>
              </div>
              <div class="kds-items">${itemLines}</div>
              ${o.notes ? `<div style="margin-top:6px;color:var(--muted);font-size:.9rem">ملاحظات: ${o.notes}</div>` : ``}
              ${addsSum ? `<div style="margin-top:4px;color:var(--muted);font-size:.9rem">إضافات: ${fmt(addsSum)} ر.س</div>` : ``}
              ${discPct ? `<div style="margin-top:4px;color:var(--muted);font-size:.9rem">خصم: ${fmt(discPct)}%</div>` : ``}
            </div>
            <div class="kds-meter"><span style="width:${prog}%; background:${mc}"></span></div>
            <div class="kds-foot">
              <button class="btn btn-ghost" onclick="printOrder(${o.id})">طباعة</button>
              <button class="btn btn-ghost" onclick="cancelOrDelete(${o.id})">حذف/إلغاء</button>
              <button class="btn btn-ghost" onclick="editOrder(${o.id})">تعديل</button>
              <button class="btn btn-primary" onclick="advanceStatus(${o.id})">${nextAction(o.status)}</button>
            </div>
          </div>`;
        }).join('');
      }

      function notify(t, msg){
        const ns = LS.get('notifications', []);
        ns.unshift({id:crypto.randomUUID(), type:'order', title:t, message:msg||'', time:nowISO(), read:false});
        LS.set('notifications', ns);
        try{ updateNotifCount(); renderNotifs(); }catch(e){}
      }

      async function setStatus(id, st){
        const orders = LS.get('orders', []);
        const o = orders.find(x=>x.id===id); if(!o) return;
        o.status = st;
        LS.set('orders', orders);
        renderKDS();
        updateCounts();
        try{ updateAll(); }catch(e){}

        try{
          if (window.supabaseBridge?.updateOrderSB) {
            await window.supabaseBridge.updateOrderSB(id, { status: st });
          }
        }catch(e){
          console.error(e);
          Modal.info('تم التحديث محلياً فقط. لم يُحدَّث في القاعدة.', 'تنبيه');
        }
      }

      window.advanceStatus = function(id){
        const orders = LS.get('orders', []);
        const o = orders.find(x=>x.id===id); if(!o) return;
        const next = statusToNext(o.status);
        setStatus(id, next);
        notify(`تحديث حالة الطلب #${fmt(id)}`, next);
      }
      window.markReady = function(id){
        const orders = LS.get('orders', []);
        const o = orders.find(x=>x.id===id); if(!o) return;
        setStatus(id, 'preparing');
        notify(`الطلب جاهز #${fmt(id)}`, 'preparing');
      }
      window.markDelivered = function(id){
        const orders = LS.get('orders', []);
        const o = orders.find(x=>x.id===id); if(!o) return;
        setStatus(id, 'delivered');
        notify(`تم التسليم #${fmt(id)}`, 'delivered');
      }
      window.markCanceled = function(id){
        const orders = LS.get('orders', []);
        const o = orders.find(x=>x.id===id); if(!o) return;
        setStatus(id, 'canceled');
        notify(`تم الإلغاء #${fmt(id)}`, 'canceled');
      }

      function buildOrderCard(o){
        const map = itemsById();
        const prog = Math.min(100, (o.status==='new'?15: o.status==='received'?50: o.status==='preparing'?85:100));
        const mc = meterColor(o.status);
        const title = (o.items?.[0]?.name || 'طلب');
        const itemLines = (o.items||[]).map(it=>{
          const nm = (map[it.itemId]?.name)||it.name||'عنصر';
          return `<div class="it"><div>${nm}</div><div class="kds-muted">× ${fmt(it.qty)}</div></div>`;
        }).join('');

        const addsSum = (o.additions && o.additions.length) ? o.additions.reduce((a,b)=>a+(Number(b.price)||0),0) : 0;
        const discPct = Number(o.discountPct||0);

        return `<div class="kds-card ${statusClass(o.status)}" data-id="${o.id}">
          <div class="hdr">
            <div class="left">
              <div class="time" title="${dateFmt(o.time)}">${timeSince(o.time)}</div>
              <span class="chip">${o.table? 'طاولة ' + fmt(o.table) : 'سفري'}</span>
              ${o.source==='salla' ? '<span class="chip">سلة</span>' : ''}
              ${o.status==='delivered'?'<span class="chip">مُسلّم</span>': (o.status==='canceled'?'<span class="chip">ملغي</span>':'')}
            </div>
            <div class="kds-muted">#${fmt(o.id)}</div>
          </div>
          <div class="body">
            <div class="row">
              <div class="title">${o.orderName || title}</div>
              <div class="kds-muted">العناصر: ${fmt(o.itemCount ?? (o.items? o.items.reduce((a,b)=>a+(b.qty||0),0) : 0))}</div>
            </div>
            <div class="kds-items">${itemLines}</div>
            ${o.notes ? `<div style="margin-top:6px;color:var(--muted);font-size:.9rem">ملاحظات: ${o.notes}</div>` : ``}
            ${addsSum ? `<div style="margin-top:4px;color:var(--muted);font-size:.9rem">إضافات: ${fmt(addsSum)} ر.س</div>` : ``}
            ${discPct ? `<div style="margin-top:4px;color:var(--muted);font-size:.9rem">خصم: ${fmt(discPct)}%</div>` : ``}
          </div>
          <div class="kds-meter"><span style="width:${prog}%; background:${mc}"></span></div>
          <div class="kds-foot">
            <button class="btn btn-ghost" onclick="printOrder(${o.id})">طباعة</button>
            <button class="btn btn-ghost" onclick="cancelOrDelete(${o.id})">حذف/إلغاء</button>
            <button class="btn btn-ghost" onclick="editOrder(${o.id})">تعديل</button>
            <button class="btn btn-primary" onclick="advanceStatus(${o.id})">${nextAction(o.status)}</button>
          </div>
        </div>`;
      }

      function renderTab(tab){
        const orders = LS.get('orders', []);
        const map = itemsById();
        const filtered = orders.filter(o => (tab==='all' ? true : o.status===tab))
                               .filter(o => matchQuery(o, map));
        const grid = document.getElementById('kdsGrid');
        if(filtered.length===0){
          grid.innerHTML = '<div class="small" style="color:var(--muted)">لا يوجد طلبات مطابقة.</div>';
          return;
        }
        grid.innerHTML = filtered.map(buildOrderCard).join('');
      }

      function printHTML(id){
        const orders = LS.get('orders', []);
        const o = orders.find(x=>x.id===id); if(!o) return '';
        const items = (o.items||[]).map(it=>`<tr><td>${it.name||'-'}</td><td style="text-align:center">${fmt(it.qty||0)}</td><td style="text-align:left">${fmt(it.price||0)}</td></tr>`).join('');
        return `
          <div style="font-family:system-ui,Arial,sans-serif;font-size:12px">
            <div style="font-weight:900;font-size:14px;margin-bottom:8px">طلب #${fmt(o.id)}</div>
            <div>الطاولة: ${o.table||'-'}</div>
            <div>الحالة: ${o.status||'-'}</div>
            <div>الوقت: ${o.time? new Date(o.time).toLocaleString('ar-EG') : '-'}</div>
            <hr/>
            <table style="width:100%;border-collapse:collapse">
              <thead><tr><th style="text-align:right">الصنف</th><th style="text-align:center">الكمية</th><th style="text-align:left">السعر</th></tr></thead>
              <tbody>${items}</tbody>
            </table>
            <hr/>
            <div style="display:flex;justify-content:space-between">
              <div>المجموع</div><div>${fmt(o.total||0)} ل.س</div>
            </div>
          </div>
        `;
      }

      window.printOrder = function(id){
        const w = window.open('', '_blank');
        if(!w) return;
        w.document.write(`<!DOCTYPE html><html><head><title>طباعة</title></head><body>${printHTML(id)}</body></html>`);
        w.document.close();
        try{ w.focus(); w.print(); }catch(e){}
        setTimeout(()=> w.close(), 300);
      }

      window.cancelOrDelete = async function(id){
        const orders = LS.get('orders', []);
        const o = orders.find(x=>x.id===id); if(!o) return;
        if(o.status === 'canceled'){
          const yes = await Modal.confirm('حذف الطلب نهائياً؟','تأكيد الحذف');
          if(!yes) return;
          try{
            if (window.supabaseBridge?.deleteOrderSB) {
              await window.supabaseBridge.deleteOrderSB(id);
            } else {
              LS.set('orders', orders.filter(x=>x.id!==id));
            }
          }catch(e){
            console.error(e);
            Modal.info('تعذّر الحذف من القاعدة.','خطأ');
          }
          renderKDS(); updateCounts(); try{ updateAll(); }catch(e){}
          return;
        }
        const ok = await Modal.confirm('إلغاء هذا الطلب؟','تأكيد الإلغاء');
        if(!ok) return;
        await setStatus(id,'canceled');
      }

      window.editOrder = function(id){
        const orders = LS.get('orders', []);
        const o = orders.find(x=>x.id===id); if(!o) return;

        const items = o.items||[];
        const body = `
          <div class="small" style="margin-bottom:8px;color:#6b7280">#${fmt(o.id)} — ${o.orderName||'طلب'}</div>
          <div style="display:grid;gap:8px">
            <label class="app-label">الطاولة</label>
            <input id="eTable" class="app-input" value="${o.table||''}" />
            <label class="app-label">ملاحظات</label>
            <textarea id="eNotes" class="app-input" rows="3">${o.notes||''}</textarea>
            <div style="height:10px"></div>
            <div class="small" style="color:#6b7280">العناصر</div>
            <div id="eItems">${items.map((it,i)=>`
              <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;margin-bottom:6px">
                <input id="n${i}" class="app-input" value="${it.name||''}" />
                <input id="q${i}" class="app-input" type="number" min="1" value="${it.qty||1}" />
                <input id="p${i}" class="app-input" type="number" step="0.01" value="${it.price||0}" />
              </div>`).join('')}
            </div>
          </div>
        `;

        showModal({
          title: 'تعديل الطلب',
          bodyHTML: body,
          actions: [
            { label: 'حفظ', className:'btn btn-primary', onClick: async ()=>{
              const table = document.getElementById('eTable').value.trim();
              const notes = document.getElementById('eNotes').value.trim();
              const updated = items.map((it,i)=>({
                name: document.getElementById(`n${i}`).value,
                qty: Number(document.getElementById(`q${i}`).value||0),
                price: Number(document.getElementById(`p${i}`).value||0),
                itemId: it.itemId
              })).filter(x=>x.name);

              o.table = table; o.notes = notes; o.items = updated;
              o.itemCount = updated.reduce((a,b)=>a+(b.qty||0),0);
              o.total = updated.reduce((a,b)=>a+(b.qty||0)*(Number(b.price)||0),0);
              LS.set('orders', orders);
              renderKDS(); updateCounts(); try{ updateAll(); }catch(e){}
              hideModal();

              const ns = LS.get('notifications', []);
              ns.unshift({ id: crypto.randomUUID(), type:'order', title:`تعديل الطلب #${fmt(o.id)}`, message:'', time: nowISO(), read:false });
              LS.set('notifications', ns);

              if (window.supabaseBridge?.updateOrderSB) {
                try{
                  await window.supabaseBridge.updateOrderSB(o.id, { total:o.total });
                }catch(e){
                  console.error(e);
                  Modal.info('تعذّر مزامنة المجموع مع القاعدة.','تنبيه');
                }
              }
            }},
            { label: 'إلغاء', className:'btn btn-ghost', onClick: hideModal }
          ]
        });
      }

      function groupActiveOrders(){
        const orders = LS.get('orders', []);
        const active = orders.filter(o=>o.status!=='delivered' && o.status!=='canceled');
        const map = {};
        active.forEach(o=>{
          (o.items||[]).forEach(it=>{
            const key = it.name || it.itemId || 'x';
            if(!map[key]) map[key] = { name: it.name || 'عنصر', qty:0, price: Number(it.price)||0 };
            map[key].qty += Number(it.qty)||0;
          });
        });
        const list = Object.values(map).sort((a,b)=>b.qty-a.qty);
        return list;
      }

      function openGroupModal(){
        const g = groupActiveOrders();
        const html = `
          <div class="small" style="color:#6b7280">دمج كل الطلبات النشطة (جديد/قيد التحضير/جاهز) وعرض مجموع الكميات لكل صنف.</div>
          <div class="small" style="margin-top:8px;color:#6b7280">استخدم هذا العرض لإرسال طلبية للمطبخ بسرعة.</div>
          <div style="margin-top:10px;max-height:60vh;overflow:auto">
            ${ g.length ? g.map(x => `
              <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;border:1px solid #eee;border-radius:10px;padding:8px 10px;margin-bottom:8px">
                <div>${x.name}</div>
                <div class="mono">× ${fmt(x.qty)}</div>
                <div class="mono">${fmt(x.price)} ل.س</div>
              </div>
            `).join('') : '<div class="small" style="color:#6b7280">لا يوجد طلبات نشطة.</div>'}
          </div>
        `;
        document.getElementById('groupBody').innerHTML = html;
        document.getElementById('groupModal').classList.add('open');
      }

      document.getElementById('closeGroup').addEventListener('click', ()=>{
        document.getElementById('groupModal').classList.remove('open');
      });

      document.getElementById('groupBtn').addEventListener('click', openGroupModal);

      document.getElementById('kdsTabs').addEventListener('click', (e)=>{
        const btn = e.target.closest('button.kds-tab'); if(!btn) return;
        document.querySelectorAll('.kds-tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const st = btn.getAttribute('data-st');
        state.tab = st;
        renderTab(st);
      });

      document.getElementById('searchOrders').addEventListener('input', (e)=>{
        state.q = e.target.value || '';
        renderTab(state.tab);
      });

      document.getElementById('demoOrder').addEventListener('click', async ()=>{
        const items = LS.get('menuItems', []);
        if(!items.length){
          Modal.info('لا توجد عناصر منيو متاحة حالياً.','تنبيه');
          return;
        }
        const pick = items.slice(0, 5 + Math.floor(Math.random()*5));
        const selected = pick.map(it=>({ itemId: it.id, name: it.name, price: it.price, qty: 1 + Math.floor(Math.random()*2) }));
        const total = selected.reduce((a,b)=>a+b.qty*b.price,0);
        const orders = LS.get('orders', []);
        const id = Math.max(0, ...orders.map(o=>Number(o.id)||0)) + 1;
        const order = {
          id,
          orderName: 'عينة',
          table: String(1 + Math.floor(Math.random()*10)),
          items: selected,
          itemCount: selected.reduce((a,b)=>a+b.qty,0),
          total,
          time: new Date().toISOString(),
          status: 'new',
          source: 'demo'
        };
        orders.unshift(order);
        LS.set('orders', orders);
        renderKDS(); updateCounts(); try{ updateAll(); }catch(e){}

        const ns = LS.get('notifications', []);
        ns.unshift({
          id: crypto.randomUUID(),
          type: 'order',
          title: `طلب جديد #${fmt(id)}`,
          message: `المجموع ${fmt(total)} ل.س`,
          time: nowISO(),
          read:false
        });
        LS.set('notifications', ns);

        if (window.supabaseBridge?.createOrderSB) {
          try{
            await window.supabaseBridge.createOrderSB({
              order_name: order.orderName,
              phone: '',
              table_no: order.table,
              notes: '',
              items: selected.map(x=>({ id:x.itemId, name:x.name, price:x.price, qty:x.qty }))
            });
          }catch(e){
            console.error(e);
            Modal.info('تعذّر الإرسال إلى القاعدة. تم إنشاء الطلب محلياً فقط.','تنبيه');
          }
        }
      });

      function init(){
        renderKDS();
        updateCounts();
      }

      document.addEventListener('DOMContentLoaded', init);
      window.addEventListener('storage', (e)=>{
        if(!e || !e.key || ['orders','notifications','menuItems'].includes(e.key)){
          try{ renderKDS(); updateCounts(); }catch(e){}
        }
      });
    })();
  </script>

  <!-- Global App Modal -->
  <div id="appModal" class="modal" aria-hidden="true">
    <div class="card" style="padding:0;background:#fff;color:#111;max-width:min(560px,95vw)">
      <div class="head" style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #eee">
        <strong id="appModalTitle">إشعار</strong>
        <button class="btn btn-ghost" id="appModalClose">إغلاق</button>
      </div>
      <div class="body" id="appModalBody" style="padding:14px;max-height:60vh;overflow:auto"></div>
      <div class="actions" id="appModalActions" style="display:flex;gap:8px;justify-content:flex-start;padding:12px 14px;border-top:1px solid #eee"></div>
    </div>
  </div>

  <!-- الأهم: تحميل admin.js أولاً ليدير الإشعارات ثم سكربت الصفحات -->
  <script src="admin.js"></script>
  <script src="admin-multipage.js"></script>
</body>
</html>
